<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hiyori Live2D – Stabil v6!</title>
  <style>
    * { margin:0; padding:0; }
    body, html { height:100%; overflow:hidden; background:linear-gradient(135deg, #fff0f8, #e3f2fd); font-family: 'Segoe UI', Arial; }
    canvas { display:block; width:100%; height:100%; }
    #info {
      position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
      background:rgba(255,255,255,0.95); padding:10px 20px; border-radius:25px;
      font-size:14px; color:#d81b60; box-shadow:0 3px 15px rgba(0,0,0,0.1);
      max-width:85%; text-align:center; pointer-events:none; z-index:10;
    }
    #info::before { content: "Waifu: "; font-weight:bold; }
  </style>
</head>
<body>

<canvas id="canvas"></canvas>
<div id="info">Loading Hiyori... Versi stabil, pasti jalan!</div>

<!-- 1. Live2D Core (CDN Resmi) -->
<script src="https://cubism.live2d.com/sdk-web/live2dcubismcore.min.js"></script>

<!-- 2. PixiJS v6 (STABIL buat plugin v0.4.0) -->
<script src="https://cdn.jsdelivr.net/npm/pixi.js@6/dist/pixi.min.js"></script>

<!-- 3. Plugin Live2D (LOKAL v0.4.0 – JAMINAN LOAD!) -->
<script src="js/live2d-plugin.min.js"></script>

<script>
// Expose PIXI
window.PIXI = PIXI;

// Tunggu load + retry
let retryCount = 0;
const maxRetries = 5;
function checkAndInit() {
  if (!PIXI.live2d || !PIXI.live2d.Live2DModel) {
    retryCount++;
    if (retryCount < maxRetries) {
      document.getElementById("info").textContent = `Plugin loading... (retry ${retryCount}/${maxRetries})`;
      setTimeout(checkAndInit, 500 * retryCount); // Delay bertambah
      return;
    } else {
      document.getElementById("info").textContent = "Error: Plugin gagal total! Cek console F12.";
      console.error("Live2DModel undefined after retries!");
      return;
    }
  }
  initLive2D();
}

window.addEventListener("load", checkAndInit);

function initLive2D() {
  // Pixi App v6
  const app = new PIXI.Application({
    view: document.getElementById("canvas"),
    transparent: true,
    autoResize: true,
    resizeTo: window
  });

  window.addEventListener("resize", () => {
    app.renderer.resize(window.innerWidth, window.innerHeight);
  });

  // Load Hiyori
  (async () => {
    try {
      const model = await PIXI.live2d.Live2DModel.from("live2d/hiyori/Hiyori.model3.json");
      app.stage.addChild(model);

      // Ukuran & posisi (optimized v6)
      const scale = window.innerWidth < 600 ? 0.22 : 0.32;
      model.scale.set(scale);
      model.anchor.set(0.5, 0.5);
      model.position.set(window.innerWidth / 2, window.innerHeight - 120);

      // Idle kedip
      model.motion("idle");

      // Ucapan
      const greetings = [
        "Halo! Seneng ketemu kamu~",
        "Hai! Lagi apa?",
        "Kyaa~ Jangan klik mulu!",
        "Aku Hiyori, salam kenal!",
        "Yay! Kamu klik aku lagi!"
      ];

      // Hit klik body
      model.on("hit", (hitAreas) => {
        if (hitAreas.includes("Body")) {
          const text = greetings[Math.floor(Math.random() * greetings.length)];
          speak(text);
          model.motion("tap_body");
          document.getElementById("info").textContent = text;
        }
      });

      // Drag (v6 compatible)
      model.interactive = true;
      let dragging = false;
      model.on("pointerdown", () => dragging = true);
      model.on("pointerup", () => dragging = false);
      model.on("pointerupoutside", () => dragging = false);
      app.stage.on("pointermove", (e) => {
        if (dragging) {
          model.position.set(e.global.x, e.global.y);
        }
      });

      document.getElementById("info").textContent = "Halo Hiyori! Klik body-nya~";

    } catch (err) {
      document.getElementById("info").textContent = "Error model: " + err.message;
      console.error("Model error:", err);
    }
  })();
}

// TTS
function speak(text) {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "id-ID";
    utterance.rate = 0.9;
    utterance.pitch = 1.3;
    utterance.volume = 1;
    speechSynthesis.speak(utterance);
  }
}
</script>

</body>
</html>
